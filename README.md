# 🐱 Hirsakam Icon Generator

Hirsakamの画像に絵文字、テキスト、フリーハンド描画、オーバーレイ画像を追加してオリジナルコラ画像を生成するWebアプリケーションです。

**🎉 最新機能**:
- 📤 **Slack連携機能**: ガチャ結果と生成画像をSlackに直接共有、高画質スクリーンショット自動送信
- 🎰 **ガチャシステム**: 確率に基づくランダム画像抽選機能（N:50%, R:30%, SR:17%, SSR:3%）、単発・10連ガチャ対応、レアリティ別特殊エフェクト、GIFアニメーション対応
- ✂️ **画像トリミング機能**: ベース画像の任意の範囲を選択してトリミング、独立したトリミングモードで直感的な操作
- 🔄 **完全回転機能**: テキスト・絵文字・オーバーレイ画像すべてをマウスまたはスライダーで自由回転
- 🔀 **左右反転機能**: 絵文字・オーバーレイ画像をワンクリックで左右反転（ミラー効果）
- 📐 **レイヤー順序制御**: 要素の重ね順を自由に変更可能（ベース画像 → テキスト/絵文字/オーバーレイ → フリーハンド描画）
- 🖼️ **自動画像圧縮**: 大きな画像を自動でサイズ制限内に圧縮
- 🎯 **境界外配置**: 要素を画像フレーム外まで自由に配置可能
- ✨ **強化された描画機能**: カスタム画像でも描画が正常動作、描画内容の永続保持、描画モード時も回転状態を保持
- 🎭 **AI背景透過**: オーバーレイ画像の背景を自動除去してベース画像に自然に合成
- 📚 **ギャラリー機能**: 生成画像の一覧表示、ソート機能、ページング表示（16件/ページ）

Hirsakamとは→下の猫ちゃんです。可愛いですね。
![Image](https://github.com/user-attachments/assets/9e507d87-400b-467b-b8b6-e234c4c69135)

## 📁 ディレクトリ構造

```
hirsakam_icon_generator/
├── run.py                  # 実行スクリプト
├── hirsakam.jpg           # デフォルトのベース画像
├── output/                # 生成された画像の保存先
├── temp_uploads/          # アップロード画像の一時保存
├── hirsakam_gacha_image/  # ガチャ画像素材
│   ├── normal/                 # N レアリティ（50%）
│   ├── rare/                   # R レアリティ（30%）
│   ├── super_rare/             # SR レアリティ（17%）
│   └── special_super_rare/     # SSR レアリティ（3%、GIF対応）
├── other_image/           # その他の画像素材
├── env/                   # 統一された環境変数設定
│   └── .env                    # 環境変数ファイル（Slack設定など）
├── backend/               # バックエンド（FastAPI）
│   ├── app.py                  # Web API サーバー
│   ├── hirsakam_icon_generator.py  # 画像生成エンジン
│   ├── requirements.txt        # Python依存関係
│   └── venv/                   # バックエンド用Python仮想環境
├── frontend/              # フロントエンド（React）
│   ├── src/
│   │   ├── App.js              # メインアプリケーション
│   │   ├── App.css             # スタイルシート
│   │   └── ...
│   ├── public/
│   ├── package.json            # Node.js依存関係
│   └── node_modules/           # Node.js依存関係（自動生成）
└── venv/                  # メイン用Python仮想環境
```

## 🚀 起動方法

### 簡単起動（デフォルト）

```bash
python3 run.py
```

### その他のオプション

```bash
python3 run.py both      # 両方同時に起動（上と同じ）
python3 run.py backend   # バックエンドのみ
python3 run.py frontend  # フロントエンドのみ
python3 run.py help      # ヘルプ表示
```

## 🌐 アクセス先

- **フロントエンド**: http://localhost:3000
- **バックエンドAPI**: http://localhost:8000
- **API ドキュメント**: http://localhost:8000/docs

## ⚙️ サーバー環境での設定

### 統一された環境変数設定

**env/.env ファイル設定例** (推奨):
```bash
# 統一された環境変数設定ファイル
# バックエンド・フロントエンド共通で使用

# サーバーURL設定（オプション）
# 設定しない場合は自動検出されます
SERVER_URL=http://your-server.com

# 例:
# SERVER_URL=http://localhost        # ローカル開発
# SERVER_URL=http://your-server.com  # 本番環境
# SERVER_URL=*                       # 全オリジン許可（テスト用のみ）

# Slack連携設定（オプション）
# 新しいSlack API (files_upload_v2) を使用
# Bot Token (xoxb-で始まる) が必要
# 必要なスコープ: files:write, chat:write
SLACK_BOT_TOKEN=xoxb-your-bot-token-here
SLACK_DEFAULT_CHANNEL=#tmp-hirsakam-icon-generator
```

### Slack連携のセットアップ

Slack連携機能を使用する場合は、以下の手順でBot Tokenを取得してください:

1. [Slack API Apps](https://api.slack.com/apps) でアプリを作成
2. **OAuth & Permissions** で以下のスコープを追加:
   - `files:write` - ファイルアップロード権限
   - `chat:write` - メッセージ送信権限
3. **Install to Workspace** でワークスペースにインストール
4. **Bot User OAuth Token** (xoxb-で始まる) をコピーして`env/.env`に設定
5. Slackでチャンネルに `/invite @your-bot-name` でBotを招待

**詳細な手順**: [SLACK_MIGRATION.md](SLACK_MIGRATION.md) を参照してください。

**設定手順**:
1. `env/.env` ファイルを編集
2. 必要に応じて `SERVER_URL` を設定（コメントアウトを解除）
3. `python3 run.py` で起動

### 起動コマンド例

**統合スクリプト使用（推奨）**:
```bash
# ローカル環境（環境変数不要）
python3 run.py

# サーバー環境（env/.envファイルを使用）
python3 run.py

# 環境変数で直接指定
SERVER_URL="http://your-server" python3 run.py
```

**個別起動**:
```bash
# サーバー環境での起動（統一されたSERVER_URLを使用）
SERVER_URL="http://your-server"

# バックエンド起動
cd backend && SERVER_URL="$SERVER_URL" python3 app.py

# フロントエンド起動（SERVER_URLで統一）
cd frontend && SERVER_URL="$SERVER_URL" npm start
```

## ✨ 機能

### Web UI版（推奨）
1. **絵文字追加**: Slack風の絵文字ピッカーから選択
2. **テキスト追加**: カスタムテキストと色の変更
3. **テキスト・絵文字の独立制御**: 
   - テキストと絵文字を個別に位置調整可能
   - 同時表示しながら別々に移動
   - 個別の座標入力にも対応
   - **回転機能**: スライダーまたはマウスドラッグで自由に回転
   - **左右反転機能**: 絵文字をチェックボックスでミラー反転
4. **フリーハンド描画**: 
   - マウス/タッチでの自由な線画描画
   - 色と線の太さを調整可能
   - Undo/Redo機能
   - 描画クリア機能
5. **オーバーレイ画像**: 
   - 追加画像のアップロードと合成
   - ドラッグで位置調整
   - リサイズハンドルでサイズ変更
   - **回転機能**: スライダーまたはマウスドラッグで自由に回転
   - **左右反転機能**: チェックボックスでミラー効果を適用
   - 透明度の調整
   - **背景透過機能**: AI技術による高精度な背景除去（プレビューと生成で同一品質）
   - **自動画像圧縮**: 800KB以上の画像を自動圧縮してアップロード
6. **レイヤー順序管理**: 
   - テキスト、絵文字、オーバーレイ画像の重ね順を自由に変更
   - ドラッグ&ドロップでの直感的なレイヤー操作
   - フリーハンド描画は常に最上位レイヤー
7. **インタラクティブプレビュー**: 
   - ドラッグで位置調整（**画像境界を超えた配置も可能**）
   - 四隅のハンドルでサイズ調整
   - 赤いハンドルでマウス回転操作（全要素対応）
   - 描画モード切り替え
8. **画像トリミング**: ベース画像の任意の範囲を自由にトリミング
   - **独立したトリミングモード**: プレビューとは別の専用モードで直感的な操作
   - **ドラッグ範囲選択**: マウスドラッグで任意の矩形範囲を選択
   - **リアルタイムプレビュー**: 青いオーバーレイで選択範囲を視覚的に確認
   - **サーバーサイド処理**: 高品質なトリミング結果
9. **カスタム画像**: 独自の画像をアップロード可能
   - **自動画像圧縮**: 1MB以上の画像を自動圧縮
10. **ギャラリー**: 生成した画像の効率的な管理と表示
   - **ページング表示**: 16件ずつの見やすいページング表示
   - **ソート機能**: 新しい順・古い順で並び替え可能
   - **画像最適化**: 端が見切れない適切な画像表示
   - **一括ダウンロード**: 各画像を個別にダウンロード可能
11. **ガチャシステム**: おまけ機能として楽しめるランダム画像抽選
   - **4段階レアリティ**: N（50%）、R（30%）、SR（17%）、SSR（3%）
   - **単発・10連ガチャ**: 単発と10連ガチャを選択可能
   - **10連ガチャ特典**: 最後の1枚はSR以上確定（SR:90%、SSR:10%）
   - **レアリティ別枠**: N:白枠、R:青枠、SR:紫枠、SSR:金枠で視覚的に区別
   - **特殊エフェクト**: レアリティごとの色分けとアニメーション
   - **GIF対応**: SSRアイテムはアニメーションGIFで特別演出
   - **動的拡張**: 新しい画像を追加するだけで自動的にガチャ対象に追加
12. **改行対応テキスト**: 複数行テキストをサポート
   - **テキストエリア**: 複数行入力可能なテキストエリア
   - **改行保持**: Enterキーでの改行が画像に正しく反映
   - **プレビュー連動**: 改行がプレビューと生成画像で一致

## 🛠️ セットアップ

### 初回セットアップ

1. **仮想環境作成**
   ```bash
   python3 -m venv venv
   source venv/bin/activate  # macOS/Linux
   # または
   venv\Scripts\activate     # Windows
   ```

2. **依存関係のインストール**
   ```bash
   pip3 install -r backend/requirements.txt
   cd frontend && npm install
   ```

### 手動起動（開発者向け）

```bash
# ターミナル1: バックエンド
python3 run.py backend

# ターミナル2: フロントエンド
python3 run.py frontend
```

### 直接実行（上級者向け）

```bash
# バックエンド
cd backend && python3 app.py

# フロントエンド
cd frontend && npm start
```

## 📝 要件

- **Python 3.10+**
- **Node.js 14+**
- **npm または yarn**
- **インターネット接続**（絵文字画像ダウンロード・AI背景透過モデルダウンロード用）
- **モダンブラウザ**（Chrome、Firefox、Safari、Edge）
  - HTML5 Canvas対応
  - JavaScript ES6+対応
  - File API対応（画像アップロード・圧縮用）

## 🎨 使い方

### Web UI版
1. `python3 run.py` でアプリケーションを起動
2. ブラウザで http://localhost:3000 にアクセス
3. **基本的な使い方**:
   - テキストまたは絵文字を入力（オプション）
   - 絵文字の場合は「左右反転」チェックボックスでミラー効果も適用可能
   - 「プレビュー」ボタンをクリック
   - ドラッグして位置を調整（**画像境界を超えて配置可能**）
   - 四隅の青いハンドルでサイズ調整
   - 上部の赤いハンドルをドラッグして回転（テキスト・絵文字・オーバーレイ画像すべて対応）
   - 回転スライダーでも角度調整可能
   - 「この位置で生成」をクリック
4. **描画機能の使い方**:
   - 「プレビュー」ボタンをクリック（テキスト・絵文字なしでもOK）
   - 「描画モードを有効にする」をチェック
   - 色と線の太さを調整
   - マウスで自由に描画
   - Undo/Redoで調整、クリアでリセット
   - 「この位置で生成」をクリック
5. **オーバーレイ画像の使い方**:
   - 「オーバーレイ画像」から画像ファイルを選択
   - **大きな画像は自動的に圧縮されます**（800KB制限）
   - プレビューで画像をドラッグして位置調整（**境界外配置可能**）
   - 四隅のハンドルでサイズ変更
   - 赤いハンドルまたはスライダーで回転調整
   - 透明度スライダーで透明度を調整
   - **「背景を透過する」チェックボックスでAI背景除去**（プレビューと生成で同一品質）
   - **「左右反転」チェックボックスでミラー効果**（プレビューでも確認可能）
   - 複数の画像を重ねることも可能
6. **レイヤー順序の調整**:
   - プレビュー画面右上の「レイヤー」ボタンをクリック
   - ドラッグ&ドロップでレイヤーの順序を変更
   - フリーハンド描画は常に最上位に表示
7. **画像トリミング機能**:
   - 「ベース画像をトリミング」ボタンでトリミングモードに切り替え
   - 画像上でマウスドラッグして任意の矩形範囲を選択
   - 青色のオーバーレイで選択範囲をリアルタイム確認
   - 「トリミング確定」で選択した範囲をベース画像として設定
   - デフォルト画像・カスタム画像どちらでも使用可能
8. **カスタムベース画像**:
   - 「ベース画像をアップロード」で独自画像を使用
   - **大きな画像は自動的に圧縮されます**（1MB制限）
9. **ギャラリー機能**:
   - 生成した画像が自動的にギャラリーに保存
   - 「新しい順」「古い順」でソート可能
   - 16件ずつのページング表示で見やすく整理
   - 各画像を個別にダウンロード可能
10. **ガチャ機能**:
   - ギャラリー下部の「🎰 単発ガチャ」「🎰 10連ガチャ」ボタンから選択
   - **単発ガチャ**: 1.5秒の演出後に1枚の画像とレアリティを表示
   - **10連ガチャ**: 2秒の演出後に10枚の画像を5×2のグリッドで表示
   - **10連ガチャ特典**: 最後の1枚は「SR以上確定」バッジ付きでSR以上が確定
   - **レアリティ別枠**: N:白枠、R:青枠、SR:紫枠、SSR:金枠で視覚的に区別
   - **特殊エフェクト**: レアリティごとの色分けとアニメーション（SSR枠は光るエフェクト）
   - **キャラクター演出**: 画像キャラクターが「10゛連゛無゛料゛！゛」と宣伝
   - **Slack共有機能**: ガチャ結果右上の「📤 共有」ボタンでSlackにスクリーンショット送信
   - SSRのGIF画像は自動でアニメーション再生
11. **Slack連携**:
   - **ガチャ結果共有**: 単発・10連ガチャ結果をSlackチャンネルに自動投稿
   - **生成画像共有**: 生成直後の画像をダウンロードボタン横の「📤 共有」ボタンから直接Slackに送信
   - **高画質送信**: dom-to-imageライブラリによる高品質スクリーンショット（ガチャ）＋直接画像送信（生成画像）
   - **投稿設定**: 投稿先チャンネルを自由に設定
   - **送信状況表示**: 成功・失敗をリアルタイムでフィードバック
   - **新API対応**: Slack新API `files_upload_v2` を使用（2025年11月12日のEOL対応済み）
   - **環境変数設定**: `env/.env`でSlack Bot Token (xoxb-) を設定
   - **セットアップ手順**: 詳細は [SLACK_MIGRATION.md](SLACK_MIGRATION.md) を参照
12. 生成された画像をダウンロード・Slack共有

## 💡 ファイル構成の説明

### `app.py` vs `hirsakam_icon_generator.py`

- **`hirsakam_icon_generator.py`**: 画像生成の核となるエンジン
  - Pillowを使った画像処理
  - 絵文字・テキストの描画
  - 描画オーバーレイの合成
  
- **`app.py`**: Web API サーバー
  - FastAPIを使ったWebサーバー
  - HTTP エンドポイント提供
  - 描画データの受信・処理
  - `hirsakam_icon_generator.py`を利用

## 🛠️ トラブルシューティング

### 画像ファイルサイズエラー
**問題**: "Part exceeded maximum size of 1024KB" エラー  
**解決**: 自動画像圧縮機能で解決済み
- オーバーレイ画像: 800KB以上で自動圧縮
- ベース画像: 1MB以上で自動圧縮
- 画質を維持しながらファイルサイズを削減

### 絵文字が表示されない
```bash
# ネットワーク接続を確認
ping raw.githubusercontent.com

# requestsライブラリを再インストール
pip3 install --upgrade requests
```

### フォントが表示されない・テキストがおかしい
**症状**: プレビューは正常だが、生成画像でテキストの表示がおかしい

**原因**: サーバー環境にフォントがインストールされていない

**解決方法**:

**Rocky Linux / CentOS / RHEL の場合**:
```bash
# 基本フォントパッケージをインストール
sudo dnf install dejavu-sans-fonts liberation-fonts

# 日本語フォント（推奨）
sudo dnf install google-noto-sans-cjk-fonts google-noto-fonts-common

# または epel リポジトリから
sudo dnf install epel-release
sudo dnf install google-noto-sans-cjk-ttc-fonts
```

**Ubuntu / Debian の場合**:
```bash
# 基本フォント
sudo apt-get install fonts-dejavu fonts-liberation

# 日本語フォント
sudo apt-get install fonts-noto-cjk
```

**フォント診断**:
```bash
# 日本語フォントの確認（重要）
fc-list | grep -i "noto.*cjk\|takao\|ipa"

# 全フォントの確認
fc-list | grep -i "dejavu\|liberation\|noto"

# フォントディレクトリの確認
ls -la /usr/share/fonts/

# 日本語フォントファイルの直接確認
find /usr/share/fonts -name "*CJK*" -o -name "*Takao*" -o -name "*IPA*"
```

**自動日本語フォント検出機能**:
- システムは日本語文字を自動検出し、CJKフォントを優先使用
- Rocky LinuxでDejaVu/Liberationフォントが選択される問題を解決
- 動的フォント検索も日本語フォント優先に変更

**重要**: 日本語テキストを使用する場合は必ずCJK（中日韓）フォントをインストールしてください。

### 画像の回転がうまくいかない
- マウスドラッグ回転: 要素の中心を基準に赤いハンドルをドラッグ（テキスト・絵文字・オーバーレイ画像すべて対応）
- スライダー回転: より正確な角度調整が可能
- 複数要素が重なっている場合は、目的の要素をクリックして選択
- 描画モード中は回転状態が固定表示され、生成時も回転が保持されます

### フリーハンド描画が表示されない・消える
**解決済み**: カスタム画像での描画問題を修正
- カスタム画像アップロード後もフリーハンド描画が正常に動作
- 時間が経過しても描画内容が保持される
- キャンバス初期化時の描画保存・復元機能を改善

### 描画モード移行時の要素位置ズレ
**解決済み**: 描画モード時の座標計算を修正
- テキストと絵文字の位置が描画モード切り替え時にズレない
- 通常表示と描画モード固定表示で同一のレイアウト計算を使用
- 透明ボーダーでレイアウト構造を統一

### 仮想環境のエラー
```bash
# 仮想環境を再作成
rm -rf venv
python3 -m venv venv
source venv/bin/activate
pip3 install -r backend/requirements.txt
```

### 権限エラー
```bash
# ファイルの作成権限を確認
chmod +w output/
```

### ポートが使用中エラー
```bash
# ポートを使用しているプロセスを確認
lsof -i :3000  # フロントエンド
lsof -i :8000  # バックエンド

# プロセスを終了（PIDを確認してから）
kill -9 <PID>
```

## 🎰 ガチャ素材の管理

### ガチャ画像の追加方法
新しいガチャ画像を追加する場合は、適切なレアリティフォルダに画像を配置するだけです：

```bash
hirsakam_gacha_image/
├── normal/           # N レアリティ（50%確率）
│   ├── 新しい画像.jpg    # ← ここに追加
│   └── 別の画像.png     # ← 複数追加可能
├── rare/             # R レアリティ（30%確率）
├── super_rare/       # SR レアリティ（17%確率）
└── special_super_rare/ # SSR レアリティ（3%確率）
    └── 特別な画像.gif    # ← GIF形式推奨
```

**対応ファイル形式**: `.jpg`, `.jpeg`, `.png`, `.gif`

**注意点**:
- 画像追加後はサーバー再起動不要（即座に反映）
- SSRにはアニメーションGIFを配置することを推奨
- ファイル名は自由（日本語可能）
- 各フォルダに最低1枚の画像が必要

## 📄 ライセンス

このプロジェクトはオープンソースです。画像の使用については適切な権利を確認してください。

- **絵文字画像**: Twitter Twemoji (CC BY 4.0)
- **ベース画像**: 適切な権利を確認してください
